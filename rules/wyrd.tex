\documentclass[twopage,twocolumn,nodeprecatedcode,bg=print,a4paper]{dndbook}

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage[singlelinecheck=false]{caption}
\usepackage{listings}
\usepackage{shortvrb}
\usepackage{stfloats}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{xspace}
\usepackage{fontawesome}
\usepackage{pgffor}
\usepackage{xfp}
\usepackage{xparse}
\usepackage{pgfkeys}
\usepackage{textpos}
\usepackage{ifoddpage}
\usepackage{afterpage}
\usepackage{graphicx}
\usepackage{geometry}
\usepackage{eso-pic}

\usepackage{imakeidx}
\makeindex

\usepackage{todo}

\captionsetup[table]{labelformat=empty,font={sf,sc,bf,},skip=0pt}

\newlength{\bottomimageheight}
\newsavebox{\bottomimagebox}
\newcommand{\bottomart}[1]{
    \thispagestyle{empty}
    \sbox{\bottomimagebox}{\includegraphics[width=\paperwidth]{#1}}%
    \setlength{\bottomimageheight}{\ht\bottomimagebox}
    \enlargethispage*{-\bottomimageheight}
    \AddToShipoutPictureBG*{\AtPageLowerLeft{\includegraphics[width=\paperwidth]{#1}}}
    \begin{figure*}[b!]
        \centering
        \makebox[\paperwidth][l]{\phantom{\includegraphics[width=\paperwidth]{#1}}}
    \end{figure*}
}
\newcommand{\topart}[1]{
  \sbox{\bottomimagebox}{\includegraphics[width=\paperwidth]{#1}}%
  \setlength{\bottomimageheight}{\ht\bottomimagebox}%
  \enlargethispage*{-\bottomimageheight}%
  \AddToShipoutPictureBG*{\AtPageUpperLeft{
      \raisebox{-\bottomimageheight}{\includegraphics[width=\paperwidth]{#1}}
    }
  }
  \begin{figure*}[t!]
    \centering
    \makebox[\paperwidth][l]{\phantom{\includegraphics[width=\paperwidth]{#1}}}
  \end{figure*}
}


%% Command for The Wyrd Engine
\newcommand{\wyrd}{\textsc{The Wyrd Engine}\xspace}

%% References
\usepackage{hyperref}  
\usepackage{refcount}  
\newcommand{\pagereftext}[1]{%
    \ifnum\getpagerefnumber{#1}=\thepage
        on this page%
    \else
        on page \pageref{#1}%
    \fi
}
\newcommand{\chapref}[1]{%
    Chapter~\getrefnumber{#1}%
}
\newcommand{\fullchapref}[1]{%
    {\color{titlered}\textsc{Chapter~\getrefnumber{#1}: \nameref{#1}}}%
}

%% Fudge dice notation %%%%%%%%%%%%%%%%%
% Defining the three outcomes
\newcommand{\FudgeDieP}{\faPlusSquare\xspace}
\newcommand{\FudgeDieM}{\faMinusSquare\xspace}
\newcommand{\FudgeDieB}{\faSquare\xspace}

% Defining shorthand for single-die outcomes
\newcommand{\FudgeDie}[1]{%
    \ifx#1+\FudgeDieP
    \else\ifx#1-\FudgeDieM
    \else\FudgeDieB
    \fi\fi
}

%% Damage and Attack
\newcommand{\Attack}{\textbf{Attack}\xspace}
\newcommand{\Defend}{\textbf{Defend}\xspace}
\newcommand{\Damage}{\textbf{Damage}\xspace}

%% Stress and wounds
\newcommand{\TickedBox}{\faTimes}
\newcommand{\StressBox}{\faCircleO\xspace}
\newcommand{\MildWound}{\faHeartO\xspace}
\newcommand{\ModerateWound}{\faHeartbeat\xspace}
\newcommand{\SevereWound}{\faHeart\xspace}

\newcommand{\Repeat}[2]{%
    \ifnum#1>0
        \RepeatHelper{#1}{#2}%
    \fi
}
\newcommand{\RepeatHelper}[2]{%
    \ifnum#1>0
        #2\RepeatHelper{\numexpr#1-1\relax}{#2}%
    \fi
}

\newcommand{\TotalStress}{4}
\newcommand{\TotalMild}{3}
\newcommand{\TotalModerate}{2}
\newcommand{\TotalSevere}{1}

\NewDocumentCommand{\StressBoxes}{o}{%
    \IfNoValueTF{#1}{\Repeat{0}{\TickedBox}\Repeat{\TotalStress}{\StressBox}}%
    {\Repeat{#1}{\TickedBox}\Repeat{\numexpr \TotalStress-#1\relax}{\StressBox}}%
}
\NewDocumentCommand{\MildWounds}{o}{%
    \IfNoValueTF{#1}{\Repeat{0}{\TickedBox}\Repeat{\TotalMild}{\MildWound}}%
    {\Repeat{#1}{\TickedBox}\Repeat{\numexpr \TotalMild-#1\relax}{\MildWound}}%
}
\NewDocumentCommand{\ModerateWounds}{o}{%
    \IfNoValueTF{#1}{\Repeat{0}{\TickedBox}\Repeat{\TotalModerate}{\ModerateWound}}%
    {\Repeat{#1}{\TickedBox}\Repeat{\numexpr \TotalModerate-#1\relax}{\ModerateWound}}%
}
\NewDocumentCommand{\SevereWounds}{o}{%
    \IfNoValueTF{#1}{\Repeat{0}{\TickedBox}\Repeat{\TotalSevere}{\SevereWound}}%
    {\Repeat{#1}{\TickedBox}\Repeat{\numexpr \TotalSevere-#1\relax}{\SevereWound}}%
}

\pgfkeys{/DamageBox/.is family, /DamageBox,
    stress/.initial=0,
    mild/.initial=0,
    moderate/.initial=0,
    severe/.initial=0,
    mildtext/.initial=\underline{\hspace{3cm}}, % Default to underline
    moderatetext/.initial=\underline{\hspace{3cm}},
    severetext/.initial=\underline{\hspace{3cm}}
}

% Define the \DamageBox command with keyword arguments
\NewDocumentCommand{\DamageBox}{O{}}{%
    % Parse key-value arguments (ensures defaults apply)
    \pgfkeys{/DamageBox, #1}%
    \begin{tabular}{@{}l l@{} l@{}}
        \textbf{Stress:}  & \StressBoxes[\pgfkeysvalueof{/DamageBox/stress}] \\ 
        \textbf{Mild:}    & \MildWounds[\pgfkeysvalueof{/DamageBox/mild}] & 
        \pgfkeysvalueof{/DamageBox/mildtext} \\
        \textbf{Mod:}     & \ModerateWounds[\pgfkeysvalueof{/DamageBox/moderate}] & 
        \pgfkeysvalueof{/DamageBox/moderatetext} \\
        \textbf{Severe:}  & \SevereWounds[\pgfkeysvalueof{/DamageBox/severe}] & 
        \pgfkeysvalueof{/DamageBox/severetext}
    \end{tabular}
}

% Framed Damage Box for improved presentation
\NewDocumentCommand{\FramedDamageBox}{O{}}{%
    \begin{center}
        \begin{tcolorbox}[
            colback=white!97, % Light background
            colframe=black!75, % Darker frame for a sleek look
            boxrule=0.8pt, % Border thickness
            arc=3mm, % Rounded corners
            shadow=small, % Subtle shadow for depth
            width=0.9\linewidth, % Adjusted for readability
            fonttitle=\bfseries,
            coltitle=black!90,
            colbacktitle=black!10,
            title=Damage Boxes, % Box title
        ]
        \DamageBox[#1] % Call the existing DamageBox command with arguments
        \end{tcolorbox}
    \end{center}
}


% Translating a sequence of die rolls
\newcommand{\FudgeRoll}{\textbf{4dF}\xspace}
\newcommand{\FudgeRes}[1]{%
    \edef\tempstr{#1} % Store input string in \tempstr
    \expandafter\FudgeLoop\tempstr\relax % Expand it into the loop
}
\def\FudgeLoop#1{%
    \ifx#1\relax % Stop when reaching \relax
    \else
        \FudgeDie{#1} % Process current character
        \expandafter\FudgeLoop % Recursive call
    \fi
}

%% Skill levels %%%%%%%%%%%%%%%%%
\newcommand{\Weak}{\textbf{Weak (-1)}\xspace}
\newcommand{\Untrained}{\textbf{Untrained (0)}\xspace}
\newcommand{\Novice}{\textbf{Novice (+1)}\xspace}
\newcommand{\Skilled}{\textbf{Skilled (+2)}\xspace}
\newcommand{\Expert}{\textbf{Expert (+3)}\xspace}
\newcommand{\Superior}{\textbf{Superior (+4)}\xspace}

%% Define commands for difficulty levels %%%%%%%%%%%%%%%%%
\newcommand{\Trivial}{\textbf{Trivial (-4)}\xspace}
\newcommand{\Simple}{\textbf{Simple (-3)}\xspace}
\newcommand{\Easy}{\textbf{Easy (-2)}\xspace}
\newcommand{\Basic}{\textbf{Basic (-1)}\xspace}
\newcommand{\Challenging}{\textbf{Challenging (0)}\xspace}
\newcommand{\Difficult}{\textbf{Difficult (+1)}\xspace}
\newcommand{\Formidable}{\textbf{Formidable (+2)}\xspace}
\newcommand{\Arduous}{\textbf{Arduous (+3)}\xspace}
\newcommand{\Extreme}{\textbf{Extreme (+4)}\xspace}
\newcommand{\Impossible}{\textbf{Impossible (+5)}\xspace}

\lstset{%
  basicstyle=\ttfamily,
  language=[LaTeX]{TeX},
  breaklines=true,
}

\title{The Wyrd Engine}
\author{Thomas Mailund}

\begin{document}
\DndSetThemeColor[DmgSlateGray]

\frontmatter
\maketitle
\tableofcontents

\mainmatter%


\input{content/index.tex}

\printindex

\end{document}
